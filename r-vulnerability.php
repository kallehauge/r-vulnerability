<?php
/**
 * Plugin Name: R-Vulnerability
 * Plugin URI: https://rommel.dk/plugins
 * Description: A plugin containing a vulnerability check of active plugins.
 * Version: 2.0.0
 * Author: Rommel ApS
 * Author URI: https://rommel.dk
 * License: GPLv2
 * Text Domain: r-vulnerability
 *
 * @package WooCommerce
 * @author Rommel
 */

Namespace Rommel;

use Rommel\WpVulnDb\Client;

/**
 * Exit if accessed directly.
 */
if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

/**
 * Autoload vendor dependencies.
 */
require __DIR__ . '/vendor/autoload.php';

/**
 * Include our classes.
 */
require __DIR__ . '/includes/class-vulnerability-service.php';
require __DIR__ . '/includes/class-vulnerability-rest.php';
require __DIR__ . '/includes/class-vulnerability-admin-widget.php';

/**
 * Define constant containing the text-domain for this plugin.
 */
define('R_VULNERABILITY', 'r-vulnerability');

/**
 *
 */
class Vulnerability {

	/**
	 * The single instance of the class.
	 *
	 * @var Vulnerability
	 */
	protected static $_instance = null;

	/**
	 * The service that handles logic about "WPScan Vulnerability Database".
	 *
	 * @var Vulnerability_Service $service
	 */
	protected $service;

	/**
	 * The plugin text domain.
	 *
	 * @var string
	 */
	protected $text_domain;

	/**
	 * Constructor.
	 */
	public function __construct() {
		$this->text_domain = R_VULNERABILITY;
		$this->service = new Vulnerability_Service( ( new Client() ) );
	}

	/**
	 * Get a Vulnerability Instance.
	 *
	 * Ensures only one instance of R_Vulnerability is loaded or can be loaded.
	 *
	 * @since 1.0.0
	 * @static
	 *
	 * @return Vulnerability
	 *   The single instance of the class.
	 */
	public static function instance() {
		if ( is_null( self::$_instance ) ) {
			self::$_instance = new self();
		}
		return self::$_instance;
	}

	/**
	 * Add a widget to the dashboard.
	 */
	public function admin_widget() {
		add_action( 'wp_dashboard_setup', [ new Vulnerability_Admin_Widget( $this->text_domain, $this->service ), 'init' ] );
	}

	/**
	 * Add a custom REST endpoint for external services to call.
	 */
	public function external_access() {
		add_action( 'rest_api_init', [ new Vulnerability_REST( $this->text_domain, $this->service ), 'init' ] );
	}
}

$r_vulnerability = Vulnerability::instance();
$r_vulnerability->admin_widget();
$r_vulnerability->external_access();
